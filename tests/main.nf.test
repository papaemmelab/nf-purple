nextflow_pipeline {

    name "Test Workflow main.nf"
    script "main.nf"
    autoSort false

    test("Should run Main.nf with failures on sage.") {

        when {
            params {
                ensemblDataDir = "${projectDir}/tests/data/ref/ensembl_data"
            }
        }
        then {
            with(workflow) {
                // Tests are expected to fail at Sage and Purple. Best we can do
                assert failed
                assert exitStatus == 1
                assert trace.tasks().size() == 4
                assert workflow.trace.succeeded().size() == 2 // Amber, Cobalt
                assert workflow.trace.failed().size() == 2 // Sage, Purple
                assert workflow.stdout.any{ 
                    it.contains('Cannot invoke "java.util.List.stream()" because "geneDataList" is null') 
                }
            }
        }
    }
}
