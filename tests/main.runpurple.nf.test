nextflow_process {

    name "Test Process runPurple"
    script "main.nf"
    process "runPurple"

    test("Should run Purple with failures") {

        setup {
            run("runAmber") {
                script "main.nf"
                process {
                    """
                    input[0] = Channel.value(params.tumor)
                    input[1] = Channel.fromPath(params.tumorBam)
                    """
                }
            }

            run("runCobalt") {
                script "main.nf"
                process {
                    """
                    input[0] = Channel.value(params.tumor)
                    input[1] = Channel.fromPath(params.tumorBam)
                    """
                }
            }
        }

        when {
            params {
                tumor = "TEST"
                tumorBam = "${projectDir}/tests/data/tumor.bam"
                outdir = "${projectDir}/tests/outdir"
                refGenome = "${projectDir}/tests/data/reference.fasta"
            }
            process {
                """
                input[0] = Channel.value(params.tumor)
                input[1] = Channel.fromPath(params.refGenome)
                input[2] = Channel.fromPath(params.refGenome + ".fai")
                input[3] = Channel.fromPath(params.refGenome + ".dict")
                input[4] = runAmber.out
                input[5] = runCobalt.out
                """
            }
        }

        then {
            // Purple process should fail when trying to create the segmentation plots
            assert process.failed
            assert process.exitStatus == 1
            assert process.errorReport.contains(
                "[ERROR] - failed processing sample(TEST): java.lang.NullPointerException"
            )
        }

    }

}
