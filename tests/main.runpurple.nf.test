nextflow_process {

    name "Test Process runPurple"
    script "main.nf"
    process "runPurple"

    test("Should run Purple with failures") {
        setup {
            run("runAmber") {
                script "main.nf"
                process {
                    """
                    input[0] = Channel.value(params.tumor)
                    input[1] = Channel.value(params.normal)
                    input[2] = Channel.fromPath(params.tumorBam)
                    input[3] = Channel.fromPath(params.normalBam)
                    """
                }
            }
            run("runCobalt") {
                script "main.nf"
                process {
                    """
                    input[0] = Channel.value(params.tumor)
                    input[1] = Channel.value(params.normal)
                    input[2] = Channel.fromPath(params.tumorBam)
                    input[3] = Channel.fromPath(params.normalBam)
                    """
                }
            }
        }
        when {
            params {
                tumor = "TEST_TUMOR"
                normal = "TEST_NORMAL"
                tumorBam = "${projectDir}/tests/data/tumor.bam"
                normalBam = "${projectDir}/tests/data/normal.bam"
                outdir = "${projectDir}/tests/outdir"
                refGenome = "${projectDir}/tests/data/reference.fasta"
            }
            process {
                """
                input[0] = Channel.value(params.tumor)
                input[1] = Channel.value(params.normal)
                input[2] = runAmber.out
                input[3] = runCobalt.out
                input[4] = "${params.outdir}/cobalt"
                """
            }
        }
        then {
            // Purple process should fail when trying to create the segmentation plots
            assert process.failed
            assert process.exitStatus == 1
            assert process.errorReport.contains("[ERROR]")
        }

    }

}
